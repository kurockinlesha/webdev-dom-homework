<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <div id="preloader">
      <p>Пожалуйста подождите, загружаю комментарии ...</p>
    </div>
    <ul id="comments__list" class="comments">
    </ul>
    <div id="preloadCom">
    </div>
    <div class="add-form">
      <input id="name__input" type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea id="comment__textarea" type="textarea" class="add-form-text" placeholder="Введите ваш коментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button id="add-form__button" class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>

<script>
  const btn = document.querySelector(".add-form-button");
  const ul = document.querySelector(".comments");
  const form = document.querySelector(".add-form");
  const buttonElement = document.getElementById("add-form__button");
  const listElement = document.getElementById("comments__list");
  const nameInputElement = document.getElementById("name__input");
  const textareaElement = document.getElementById("comment__textarea");
  const nameUser = document.querySelector(".add-form-name");
  const commentUser = document.querySelector(".add-form-text");

  const userComments = document.querySelector('.comments');
  let userComment = [];

  const apiGet = () => {
    return fetch("https://wedev-api.sky.pro/api/v1/alexey-kurochkin/comments", {
      method: "GET"
    })
      .then((response) => {
        return response.json()
      })
      .then((responseData) => {
        userComment = responseData.comments.map((comment) => {

          let date = new Date();
          let day = date.getDate();
          let month = date.getMonth() + 1;
          let year = date.getFullYear() - 2000;
          let hour = date.getHours();
          let minute = date.getMinutes();
          if (month < 10) {
            month = "0" + month;
          }
          if (hour < 10) {
            hour = "0" + hour;
          }
          if (minute < 10) {
            minute = "0" + minute;
          }
          date = day + "." + month + "." + year + "  " + hour + ":" + minute;

          return {
            id: comment.id,
            name: comment.author.name,
            date: date,
            comment: comment.text,
            likes: comment.likes,
            isLike: true,
          }
        })

        renderUserComments();

      });
  }

  apiGet().then(() => {
    window.onload = function () {
      let preloader = document.getElementById('preloader');
      preloader.classList.add('preload');
    }
    let preloader = document.getElementById('preloader');
    preloader.classList.add('preloader-hidden');
  })

  const addComment = () => {
    const loader = document.getElementById('preloadCom');
    form.className = "preloader-hidden";
    loader.textContent = 'Комментарий загружается ...';

    return fetch("https://wedev-api.sky.pro/api/v1/alexey-kurochkin/comments", {
      method: "POST",
      body: JSON.stringify({
        text: commentUser.value,
        name: nameUser.value,
      }),
    })
      .then((response) => {
        return response.json();
      })
      .then(() => {
        nameUser.value = "";
        commentUser.value = "";
      })
      .then(() => {
        loader.className = "preloader-hidden";
      })
      .then(() => {
        return apiGet();
      })
      .then(() => {
        form.className = "add-form";
      })

    initLikesBtn();

    renderUserComments();

  }

  const initLikesBtn = () => {

    const likeBtns = document.querySelectorAll('.like-button');

    for (const likeBtn of likeBtns) {
      const index = likeBtn.dataset.index;
      likeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (userComment[index].isLike === true) {
          userComment[index].likes = userComment[index].likes += 1;
          userComment[index].isLike = false;
        }

        else {
          userComment[index].likes = userComment[index].likes -= 1;
          userComment[index].isLike = true;
        }
        renderUserComments();
      });
    }
  };

  const findTextarea = () => {

    const textareas = document.querySelectorAll('.add-form-text');

    for (const textarea of textareas) {
      textarea.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  };

  function commentComment() {

    const comments = document.querySelectorAll(".comment");

    for (const comment of comments) {
      comment.addEventListener('click', () => {
        const index = comment.dataset.index;
        commentUser.value = '>' + userComment[index].comment + '\n' + '\n' + userComment[index].name + ' ,';
      });
    };
  };

  const sendingCom = () => {

    btn.addEventListener("click", () => {
      addComment();
    });

    form.addEventListener("keyup", (e) => {
      if (e.key == "Enter") {
        addComment();
      }
    });

  }
  sendingCom();

  const renderUserComments = () => {
    userComments.innerHTML = userComment.map((comments, index) => {
      return `
    <li class="comment" data-index=${index}>
    <div class="comment-header">
      <div>${comments.name}</div>
      <div>${comments.date}</div>
    </div>
    <div class="comment-body">
      <div class="comment-text">
        ${comments.comment}
      </div>
    </div>
    <div class="comment-footer">
      <div class="likes">
        <span class="likes-counter">${comments.likes}</span>
        <button class="like-button ${comments.isLike ? "" : "-active-like"}" data-index=${index} data-like=${comments.isLike}></button>
      </div>
    </div>
  </li>`
    }).join('');

    initLikesBtn();

    commentComment();

    findTextarea();

  };

  renderUserComments();

</script>

</html>